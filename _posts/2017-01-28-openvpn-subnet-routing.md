---
layout: post
title: Forwarding subnets with OpenVPN
---

Have you ever needed to forward a LAN subnet through a VPN? Well for some reason I have. 
Here is how I did it.

## The Setup

- An Intel NUC running Fedora 25
- 3 raspberry pi's running raspian
- All computers connected to an ethernet switch
- The nuc is connected to the internet via wifi

## Step 1: Install the OpenVPN server

In this project I am using the Intel NUC as my OpenVPN server. To get the server started
I used [this script](https://github.com/Nyr/openvpn-install). The OpenVPN install script
gets you most of the way there

## Step 2: Customize the vpn server configuration

Edit the OpenVPN `server.conf` file located in `/etc/openvpn` to look something like this:

```nginx
port 1194
proto tcp
dev tap0
sndbuf 0
rcvbuf 0
ca ca.crt
cert server.crt
key server.key
dh dh.pem
tls-auth ta.key 0
topology subnet
server 10.8.0.0 255.255.255.0
ifconfig-pool-persist ipp.txt
push "route 10.80.1.0 255.255.255.0"
client-to-client
keepalive 10 120
cipher AES-256-CBC
comp-lzo
user nobody
group nogroup
persist-key
persist-tun
status openvpn-status.log
verb 3
crl-verify crl.pem
```

Note that in this configuration we are assuming the lan subnet is using the 10.80.1.* address.

The most important bits are:

- `dev tap0` this instructs the VPN connections to treat the connection like an ethernet device.
- `push "route 10.80.1.0 255.255.255.0"` This informs the clients that there is a subnet on the 10.80.1.0 network (You can use a different ip range if you need of course)

## Step 3: Configuring the subnet 

In order for the devices on the subnet to be aware of the devices connected via VPN they need to know of the vpn route.
Luckily all the devices on the network are assigned IP addresses via a DHCP server on the nuc. For me this meant adding
the route to the subnet configuration in the dhcpd.conf file located in `/etc/dhcp`.

```nginx
default-lease-time 600;
max-lease-time 7200;
option subnet-mask 255.255.255.0;
option broadcast-address 10.80.1.255;
option routers 10.80.1.254;
option domain-name-servers 10.80.1.1, 10.80.1.2;

subnet 10.80.1.0 netmask 255.255.255.0 {

  ## Important Bit

  option routers 10.8.0.1;

  ## End of Important Bit

  range 10.80.1.10 10.80.1.100;
}
```

## Step 4: Modify the client.conf file

All the conf files I use are generated by the OpenVPN install script we used earlier. This makes openssl configuration easy
but it doesn't use the correct device by default. To fix this simply change the `dev` from `dev tun` to `dev tap`. You'll
end up with something like this:

```nginx
client
dev tap
proto tcp
sndbuf 0
rcvbuf 0
remote localhost 1194
resolv-retry infinite
nobind
persist-key
persist-tun
remote-cert-tls server
cipher AES-256-CBC
comp-lzo
setenv opt block-outside-dns
key-direction 1
verb 3

# certificate info below
```